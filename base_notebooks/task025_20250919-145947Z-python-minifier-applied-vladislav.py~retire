def mostcolor(grid):A=[B for A in grid for B in A];return max(set(A),key=A.count)
def height(piece):
	A=piece
	if len(A)==0:return 0
	return lowermost(A)-uppermost(A)+1
def width(piece):
	A=piece
	if len(A)==0:return 0
	return rightmost(A)-leftmost(A)+1
def toindices(patch):
	A=patch
	if len(A)==0:return set()
	B=next(iter(A))
	if isinstance(B,tuple)and len(B)==2 and isinstance(B[1],tuple):C=A;return{A for(B,A)in C}
	return A
def shift(patch,directions):
	A=patch
	if len(A)==0:return A
	C,D=directions;B=next(iter(A))
	if isinstance(B,tuple)and len(B)==2 and isinstance(B[1],tuple):E=A;return{(A,(B+C,E+D))for(A,(B,E))in E}
	F=A;return{(A+C,B+D)for(A,B)in F}
def objects(grid,univalued,diagonal,without_bg):
	A=grid;H=mostcolor(A)if without_bg else None;I=[];D=set();J,K=len(A),len(A[0]);N={(A,B)for A in range(J)for B in range(K)}
	def O(loc):
		A,B=loc
		if diagonal:return{(A-1,B-1),(A-1,B),(A-1,B+1),(A,B-1),(A,B+1),(A+1,B-1),(A+1,B),(A+1,B+1)}
		return{(A-1,B),(A+1,B),(A,B-1),(A,B+1)}
	for B in N:
		if B in D:continue
		E=A[B[0]][B[1]]
		if E==H:continue
		L={(E,B)};F={B}
		while F:
			M=set()
			for C in F:
				G=A[C[0]][C[1]]
				if E==G if univalued else G!=H:L.add((G,C));D.add(C);M|={(A,B)for(A,B)in O(C)if 0<=A<J and 0<=B<K}
			F=M-D
		I.append(L)
	return I
def uppermost(patch):return min(A for(A,B)in toindices(patch))
def lowermost(patch):return max(A for(A,B)in toindices(patch))
def leftmost(patch):return min(A for(B,A)in toindices(patch))
def rightmost(patch):return max(A for(B,A)in toindices(patch))
def center(patch):A=patch;return uppermost(A)+height(A)//2,leftmost(A)+width(A)//2
def gravitate(source,destination):
	D=destination;A=source;H,I=center(A);J,K=center(D);B,C=0,0;L=set(A for(B,A)in toindices(A));M=set(A for(B,A)in toindices(D))
	if L&M:B=1 if H<J else-1
	else:C=1 if I<K else-1
	E,F=B,C;G=0
	def N(a,b):A,B=toindices(a),toindices(b);return min(abs(A-D)+abs(C-E)for(A,C)in A for(D,E)in B)==1
	while not N(A,D)and G<42:G+=1;E+=B;F+=C;A=shift(A,(B,C))
	return E-B,F-C
def solve_1a07d186(I):
	O=objects(I,True,False,True);L={}
	for A in O:L.setdefault(next(iter(A))[0],[]).append(A)
	M=[];C=[]
	for(Z,D)in L.items():
		if not D:continue
		P=[A for A in D if len(A)>=2];E,F=len(I),len(I[0])
		def Q(o):
			A,B=height(o),width(o);C=B==len(o)and A==1;D=A==len(o)and B==1
			if C:return B>=F//2
			if D:return A>=E//2
			return len(o)>=max(E,F)//2
		G=[A for A in P if Q(A)];N=[A for A in G if uppermost(A)==0 or leftmost(A)==0 or lowermost(A)==E-1 or rightmost(A)==F-1]
		if N:B=max(N,key=lambda o:len(o))
		elif G:B=max(G,key=lambda o:len(o))
		else:B=None
		if B is None:C.extend(D);continue
		for A in D:
			if A is B:continue
			if len(A)==1:
				R={A for(A,B)in toindices(A)};S={A for(A,B)in toindices(B)};T={A for(B,A)in toindices(A)};U={A for(B,A)in toindices(B)};V=R&S or T&U
				if not V:C.append(A);continue
			W=gravitate(A,B);M.append(shift(A,W));C.append(A)
	H=[list(A)for A in I]
	if C:
		X=mostcolor(I)
		for A in C:
			for(J,K)in toindices(A):H[J][K]=X
	for A in M:
		for(Y,(J,K))in A:H[J][K]=Y
	return H
def p(g):return solve_1a07d186(g)