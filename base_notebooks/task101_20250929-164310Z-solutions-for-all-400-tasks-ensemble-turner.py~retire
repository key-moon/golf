from collections import Counter,deque
def p(I,_=range):
 if not I or not I[0]:return[]
 T={};[T.__setitem__(A,T.get(A,0)+1)for B in I for A in B];k=max(T,key=T.get);D,E=len(I),len(I[0]);U=[[0]*E for A in _(D)];V=[];q=[(-1,-1),(-1,0),(-1,1),(0,-1),(0,1),(1,-1),(1,0),(1,1)]
 for F in _(D):
  for G in _(E):
   if U[F][G]or I[F][G]==k:continue
   X=deque([(F,G)]);U[F][G]=1;l=[]
   while X:Y,Z=X.popleft();l.append((I[Y][Z],(Y,Z)));[X.append((A,B))or U[A].__setitem__(B,1)for(r,F)in q for(A,B)in[(Y+r,Z+F)]if 0<=A<D and 0<=B<E and not U[A][B]and I[A][B]!=k]
   V.append(l)
 if not V:return I
 V.sort(key=lambda c:len({A for(A,B)in c}),reverse=1);m=V[0];a=lambda pxs:set()if not pxs else{(A,(B-min(A for(B,(A,r))in pxs),r-min(A for(B,(r,A))in pxs)))for(A,(B,r))in pxs};r=Counter(A for(A,B)in m);n=max(r.items(),key=lambda kv:(kv[1],-kv[0]))[0];o=[]
 for W in(1,2,3):
  b={(A,(B*W+D,r*W+E))for(A,(B,r))in a(m)for D in _(W)for E in _(W)};c={(A,B)for(A,B)in b if A!=n};M=set();H=set()
  if c:
   H={(A,B)for(r,(A,B))in c};N,S=[A for(A,B)in H],[A for(B,A)in H];A,B,J,K=min(N)-1,min(S)-1,max(N)+1,max(S)+1;h={(A,B)for A in _(A,J+1)}|{(A,K)for A in _(A,J+1)}|{(A,B)for B in _(B,K+1)}|{(J,A)for A in _(B,K+1)};e=c|{(0,A)for A in h};L=a(e);f,g=[A for(B,(A,r))in L],[A for(B,(r,A))in L];h,i=max(f)+1,max(g)+1
   for A in _(-h+1,D):
    for B in _(-i+1,E):
     r=1;P=0
     for(Q,(F,G))in L:
      R,S=A+F,B+G
      if 0<=R<D and 0<=S<E:P=1;r=r and I[R][S]==Q
      else:r=r and Q==0
     if r and P:M.add((A,B))
  if not M:
   j={(A,B)for(A,B)in b if A==n}
   if not j:continue
   H={(A,B)for(r,(A,B))in j};N,S=[A for(A,B)in H],[A for(B,A)in H];A,B,J,K=min(N)-1,min(S)-1,max(N)+1,max(S)+1;h={(A,B)for A in _(A,J+1)}|{(A,K)for A in _(A,J+1)}|{(A,B)for B in _(B,K+1)}|{(J,A)for A in _(B,K+1)};e=j|{(0,A)for A in h};L=a(e);f,g=[A for(B,(A,r))in L],[A for(B,(r,A))in L];h,i=max(f)+1,max(g)+1
   for A in _(-h+1,D):
    for B in _(-i+1,E):
     r=1;P=0
     for(Q,(F,G))in L:
      R,S=A+F,B+G
      if 0<=R<D and 0<=S<E:P=1;r=r and I[R][S]==Q
      else:r=r and Q==0
     if r and P:M.add((A,B))
  if not M:continue
  s,t=min(A for(A,B)in H),min(A for(B,A)in H)
  for(u,v)in M:w,x=u-s+1,v-t+1;o.append({(A,(B+w,r+x))for(A,(B,r))in b})
 p=[list(A)for A in I];[p[A].__setitem__(B,r)for(r,(A,B))in set().union(*o)if 0<=A<D and 0<=B<E];return p