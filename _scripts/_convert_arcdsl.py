import re
import string

from tqdm import tqdm
consts = {
"F":False,
"T":True,
"ZERO":0,
"ONE":1,
"TWO":2,
"THREE":3,
"FOUR":4,
"FIVE":5,
"SIX":6,
"SEVEN":7,
"EIGHT":8,
"NINE":9,
"TEN":10,
"NEG_ONE":-1,
"NEG_TWO":-2,
"DOWN":(1, 0),
"RIGHT":(0, 1),
"UP":(-1, 0),
"LEFT":(0, -1),
"ORIGIN":(0, 0),
"UNITY":(1, 1),
"NEG_UNITY":(-1, -1),
"UP_RIGHT":(-1, 1),
"DOWN_LEFT":(1, -1),
"ZERO_BY_TWO":(0, 2),
"TWO_BY_ZERO":(2, 0),
"TWO_BY_TWO":(2, 2),
"THREE_BY_THREE":(3, 3)
}

task2arc = {
"task001":"007bbfb7",
"task002":"00d62c1b",
"task003":"017c7c7b",
"task004":"025d127b",
"task005":"045e512c",
"task006":"0520fde7",
"task007":"05269061",
"task008":"05f2a901",
"task009":"06df4c85",
"task010":"08ed6ac7",
"task011":"09629e4f",
"task012":"0962bcdd",
"task013":"0a938d79",
"task014":"0b148d64",
"task015":"0ca9ddb6",
"task016":"0d3d703e",
"task017":"0dfd9992",
"task018":"0e206a2e",
"task019":"10fcaaa3",
"task020":"11852cab",
"task021":"1190e5a7",
"task022":"137eaa0f",
"task023":"150deff5",
"task024":"178fcbfb",
"task025":"1a07d186",
"task026":"1b2d62fb",
"task027":"1b60fb0c",
"task028":"1bfc4729",
"task029":"1c786137",
"task030":"1caeab9d",
"task031":"1cf80156",
"task032":"1e0a9b12",
"task033":"1e32b0e9",
"task034":"1f0c79e5",
"task035":"1f642eb9",
"task036":"1f85a75f",
"task037":"1f876c06",
"task038":"1fad071e",
"task039":"2013d3e2",
"task040":"2204b7a8",
"task041":"22168020",
"task042":"22233c11",
"task043":"2281f1f4",
"task044":"228f6490",
"task045":"22eb0ac0",
"task046":"234bbc79",
"task047":"23581191",
"task048":"239be575",
"task049":"23b5c85d",
"task050":"253bf280",
"task051":"25d487eb",
"task052":"25d8a9c8",
"task053":"25ff71a9",
"task054":"264363fd",
"task055":"272f95fa",
"task056":"27a28665",
"task057":"28bf18c6",
"task058":"28e73c20",
"task059":"29623171",
"task060":"29c11459",
"task061":"29ec7d0e",
"task062":"2bcee788",
"task063":"2bee17df",
"task064":"2c608aff",
"task065":"2dc579da",
"task066":"2dd70a9a",
"task067":"2dee498d",
"task068":"31aa019c",
"task069":"321b1fc6",
"task070":"32597951",
"task071":"3345333e",
"task072":"3428a4f5",
"task073":"3618c87e",
"task074":"3631a71a",
"task075":"363442ee",
"task076":"36d67576",
"task077":"36fdfd69",
"task078":"3906de3d",
"task079":"39a8645d",
"task080":"39e1d7f9",
"task081":"3aa6fb7a",
"task082":"3ac3eb23",
"task083":"3af2c5a8",
"task084":"3bd67248",
"task085":"3bdb4ada",
"task086":"3befdf3e",
"task087":"3c9b0459",
"task088":"3de23699",
"task089":"3e980e27",
"task090":"3eda0437",
"task091":"3f7978a0",
"task092":"40853293",
"task093":"4093f84a",
"task094":"41e4d17e",
"task095":"4258a5f9",
"task096":"4290ef0e",
"task097":"42a50994",
"task098":"4347f46a",
"task099":"444801d8",
"task100":"445eab21",
"task101":"447fd412",
"task102":"44d8ac46",
"task103":"44f52bb0",
"task104":"4522001f",
"task105":"4612dd53",
"task106":"46442a0e",
"task107":"469497ad",
"task108":"46f33fce",
"task109":"47c1f68c",
"task110":"484b58aa",
"task111":"48d8fb45",
"task112":"4938f0c2",
"task113":"496994bd",
"task114":"49d1d64f",
"task115":"4be741c5",
"task116":"4c4377d9",
"task117":"4c5c2cf0",
"task118":"50846271",
"task119":"508bd3b6",
"task120":"50cb2852",
"task121":"5117e062",
"task122":"5168d44c",
"task123":"539a4f51",
"task124":"53b68214",
"task125":"543a7ed5",
"task126":"54d82841",
"task127":"54d9e175",
"task128":"5521c0d9",
"task129":"5582e5ca",
"task130":"5614dbcf",
"task131":"56dc2b01",
"task132":"56ff96f3",
"task133":"57aa92db",
"task134":"5ad4f10b",
"task135":"5bd6f4ac",
"task136":"5c0a986e",
"task137":"5c2c9af4",
"task138":"5daaa586",
"task139":"60b61512",
"task140":"6150a2bd",
"task141":"623ea044",
"task142":"62c24649",
"task143":"63613498",
"task144":"6430c8c4",
"task145":"6455b5f5",
"task146":"662c240a",
"task147":"67385a82",
"task148":"673ef223",
"task149":"6773b310",
"task150":"67a3c6ac",
"task151":"67a423a3",
"task152":"67e8384a",
"task153":"681b3aeb",
"task154":"6855a6e4",
"task155":"68b16354",
"task156":"694f12f3",
"task157":"6a1e5592",
"task158":"6aa20dc0",
"task159":"6b9890af",
"task160":"6c434453",
"task161":"6cdd2623",
"task162":"6cf79266",
"task163":"6d0160f0",
"task164":"6d0aefbc",
"task165":"6d58a25d",
"task166":"6d75e8bb",
"task167":"6e02f1e3",
"task168":"6e19193c",
"task169":"6e82a1ae",
"task170":"6ecd11f4",
"task171":"6f8cd79b",
"task172":"6fa7a44f",
"task173":"72322fa7",
"task174":"72ca375d",
"task175":"73251a56",
"task176":"7447852a",
"task177":"7468f01a",
"task178":"746b3537",
"task179":"74dd1130",
"task180":"75b8110e",
"task181":"760b3cac",
"task182":"776ffc46",
"task183":"77fdfe62",
"task184":"780d0b14",
"task185":"7837ac64",
"task186":"794b24be",
"task187":"7b6016b9",
"task188":"7b7f7511",
"task189":"7c008303",
"task190":"7ddcd7ec",
"task191":"7df24a62",
"task192":"7e0986d6",
"task193":"7f4411dc",
"task194":"7fe24cdd",
"task195":"80af3007",
"task196":"810b9b61",
"task197":"82819916",
"task198":"83302e8f",
"task199":"834ec97d",
"task200":"8403a5d5",
"task201":"846bdb03",
"task202":"855e0971",
"task203":"85c4e7cd",
"task204":"868de0fa",
"task205":"8731374e",
"task206":"88a10436",
"task207":"88a62173",
"task208":"890034e9",
"task209":"8a004b2b",
"task210":"8be77c9e",
"task211":"8d5021e8",
"task212":"8d510a79",
"task213":"8e1813be",
"task214":"8e5a5113",
"task215":"8eb1be9a",
"task216":"8efcae92",
"task217":"8f2ea7aa",
"task218":"90c28cc7",
"task219":"90f3ed37",
"task220":"913fb3ed",
"task221":"91413438",
"task222":"91714a58",
"task223":"9172f3a0",
"task224":"928ad970",
"task225":"93b581b8",
"task226":"941d9a10",
"task227":"94f9d214",
"task228":"952a094c",
"task229":"9565186b",
"task230":"95990924",
"task231":"963e52fc",
"task232":"97999447",
"task233":"97a05b5b",
"task234":"98cf29f8",
"task235":"995c5fa3",
"task236":"99b1bc43",
"task237":"99fa7670",
"task238":"9aec4887",
"task239":"9af7a82c",
"task240":"9d9215db",
"task241":"9dfd6313",
"task242":"9ecd008a",
"task243":"9edfc990",
"task244":"9f236235",
"task245":"a1570a43",
"task246":"a2fd1cf0",
"task247":"a3325580",
"task248":"a3df8b1e",
"task249":"a416b8f3",
"task250":"a48eeaf7",
"task251":"a5313dff",
"task252":"a5f85a15",
"task253":"a61ba2ce",
"task254":"a61f2674",
"task255":"a64e4611",
"task256":"a65b410d",
"task257":"a68b268e",
"task258":"a699fb00",
"task259":"a740d043",
"task260":"a78176bb",
"task261":"a79310a0",
"task262":"a85d4709",
"task263":"a87f7484",
"task264":"a8c38be5",
"task265":"a8d7556c",
"task266":"a9f96cdd",
"task267":"aabf363d",
"task268":"aba27056",
"task269":"ac0a08a4",
"task270":"ae3edfdc",
"task271":"ae4f1146",
"task272":"aedd82e4",
"task273":"af902bf9",
"task274":"b0c4d837",
"task275":"b190f7f5",
"task276":"b1948b0a",
"task277":"b230c067",
"task278":"b27ca6d3",
"task279":"b2862040",
"task280":"b527c5c6",
"task281":"b548a754",
"task282":"b60334d2",
"task283":"b6afb2da",
"task284":"b7249182",
"task285":"b775ac94",
"task286":"b782dc8a",
"task287":"b8825c91",
"task288":"b8cdaf2b",
"task289":"b91ae062",
"task290":"b94a9452",
"task291":"b9b7f026",
"task292":"ba26e723",
"task293":"ba97ae07",
"task294":"bb43febb",
"task295":"bbc9ae5d",
"task296":"bc1d5164",
"task297":"bd4472b8",
"task298":"bda2d7a6",
"task299":"bdad9b1f",
"task300":"be94b721",
"task301":"beb8660c",
"task302":"c0f76784",
"task303":"c1d99e64",
"task304":"c3e719e8",
"task305":"c3f564a4",
"task306":"c444b776",
"task307":"c59eb873",
"task308":"c8cbb738",
"task309":"c8f0f002",
"task310":"c909285e",
"task311":"c9e6f938",
"task312":"c9f8e694",
"task313":"caa06a1f",
"task314":"cbded52d",
"task315":"cce03e0d",
"task316":"cdecee7f",
"task317":"ce22a75a",
"task318":"ce4f8723",
"task319":"ce602527",
"task320":"ce9e57f2",
"task321":"cf98881b",
"task322":"d037b0a7",
"task323":"d06dbe63",
"task324":"d07ae81c",
"task325":"d0f5fe59",
"task326":"d10ecb37",
"task327":"d13f3404",
"task328":"d22278a0",
"task329":"d23f8c26",
"task330":"d2abd087",
"task331":"d364b489",
"task332":"d406998b",
"task333":"d43fd935",
"task334":"d4469b4b",
"task335":"d4a91cb9",
"task336":"d4f3cd78",
"task337":"d511f180",
"task338":"d5d6de2d",
"task339":"d631b094",
"task340":"d687bc17",
"task341":"d6ad076f",
"task342":"d89b689b",
"task343":"d8c310e9",
"task344":"d90796e8",
"task345":"d9f24cd1",
"task346":"d9fac9be",
"task347":"dae9d2b5",
"task348":"db3e9e38",
"task349":"db93a21d",
"task350":"dbc1a6ce",
"task351":"dc0a314f",
"task352":"dc1df850",
"task353":"dc433765",
"task354":"ddf7fa4f",
"task355":"de1cd16c",
"task356":"ded97339",
"task357":"e179c5f4",
"task358":"e21d9049",
"task359":"e26a3af2",
"task360":"e3497940",
"task361":"e40b9e2f",
"task362":"e48d4e1a",
"task363":"e5062a87",
"task364":"e509e548",
"task365":"e50d258f",
"task366":"e6721834",
"task367":"e73095fd",
"task368":"e76a88a6",
"task369":"e8593010",
"task370":"e8dc4411",
"task371":"e9614598",
"task372":"e98196ab",
"task373":"e9afcf9a",
"task374":"ea32f347",
"task375":"ea786f4a",
"task376":"eb281b96",
"task377":"eb5a1d5d",
"task378":"ec883f72",
"task379":"ecdecbb3",
"task380":"ed36ccf7",
"task381":"ef135b50",
"task382":"f15e1fac",
"task383":"f1cefba8",
"task384":"f25fbde4",
"task385":"f25ffba3",
"task386":"f2829549",
"task387":"f35d900a",
"task388":"f5b8619d",
"task389":"f76d97a5",
"task390":"f8a8fe49",
"task391":"f8b3ba0a",
"task392":"f8c80d96",
"task393":"f8ff0b80",
"task394":"f9012d9b",
"task395":"fafffa47",
"task396":"fcb5c309",
"task397":"fcc82909",
"task398":"feca6190",
"task399":"ff28f65a",
"task400":"ff805c23",
}

import python_minifier 

def extract_functions(file_path):
  with open(file_path, 'r') as file:
    code = file.read()
  function_pattern = re.compile(r'(def (\w+)\s*\([^)]*?\):\n(?:    [^\n]*\n)+)')
  functions = function_pattern.findall(code)
  return functions

dsl_funcs = extract_functions("arc_dsl/dsl.py")
# solver_funcs = extract_functions("arc_dsl/solvers.py")
solver_funcs = extract_functions("arc_dsl/verifiers.py")

dep_re = r"(?<!\.)(\w+)"

def resolve_dependencies(impl: str):
  dependencies = set()
  queue = [impl]
  impls = [impl]

  while queue:
      current_impl = queue.pop()
      matches = re.findall(dep_re, current_impl)
      for func_impl, name in dsl_funcs:          
          if name in matches and name not in dependencies:
              dependencies.add(name)
              queue.append(func_impl)
              impls.append(func_impl)

  return dependencies, impls

s = set(string.ascii_uppercase) - set("ABCDNITFO")
name_cands = [*s, *[a+b for a in s for b in s]]

for i in tqdm(range(1,401)):
  task = f"task{i:03}"
  arc = task2arc[task]
  solver = [impl for impl, name in solver_funcs if arc in name][0]
  solver = solver.replace(f"solve_{arc}", "p").replace(f"verify_{arc}", "p")
  solver=solver.replace(":", ":\n    I=tuple(map(tuple,I))")
  solver = re.sub(r"return (x\d+)", "return [*map(list,\\1)]", solver)

  deps, impls = resolve_dependencies(solver)
  impl = "\n".join(impls[::-1])

  for name, val in reversed(consts.items()):
    impl = impl.replace(name, repr(val))

  deps = sorted(deps, key=len, reverse=True)
  for dep, name in zip(deps, name_cands):
    impl = re.sub(rf"(?<!\.){dep}", name, impl)

  impl = python_minifier.minify(impl)

  open(f"base_rearc/{task}.py", "w").write(impl)