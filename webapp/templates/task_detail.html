{% extends "base.html" %}
{% block title %}Task {{ '%03d'|format(task_id) }} - ARC-AGI Golf{% endblock %}
{% block content %}
<div id="root" data-task-id="{{ task_id }}">
  <div style="display:flex; gap: 16px; align-items: flex-start;">
    <div style="flex:1 1 50%; min-width: 0;">
      <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px">
        <h2 id="title" style="margin:0">task{{ '%03d'|format(task_id) }}</h2>
        <button id="btnInit" class="secondary btn-slim" title="Initialize code for this task">Init</button>
      </div>
      <div id="meta" style="margin:-4px 0 12px 0; font-size: 0.9em; color: var(--muted-color);"></div>
      <section>
        <div style="margin:6px 0 10px 0">
          <strong id="tagsLabel" style="cursor:pointer" title="Click to toggle tag editor">Tags</strong><br/>
          <div id="tagEditor" style="display:flex; gap:6px; flex-wrap:wrap"></div>
        </div>
        <div id="codeBlock" style="margin:6px 0 10px 0">
          <strong>Code (dist)</strong><br/>
          <pre style="max-height:360px; overflow:auto; border:1px solid var(--pico-muted-border-color, #ccc); padding:8px; border-radius:6px;"><code id="codeSummary" class="language-python">loading…</code></pre>
        </div>
      </section>
    </div>
    <div style="flex:1 1 50%; min-width: 0;">
      <section>
        <h4 style="margin: 8px 0 6px 0">Score Progress</h4>
        <div id="chartWrap" style="position:relative">
          <canvas id="chart" height="300" style="width:100%; min-width: 800px;"></canvas>
          <div id="tooltip" class="tooltip" style="display:none"></div>
          <canvas id="overlay" style="position:absolute; inset:0; pointer-events:none"></canvas>
        </div>
        <div id="progLegend" style="margin-top:8px; display:flex; flex-wrap:wrap; gap:8px; font-size:0.9em;"></div>
      </section>
    </div>
  </div>
  <!-- Full-width Cases section below the two-column layout -->
  <section>
    <div style="display:flex; gap:8px; align-items:center; margin:8px 0; flex-wrap:wrap">
      <a href="/tasks/{{task_id}}/cases" class="btn-slim">Open all cases »</a>
      <div class="seg" id="sizeBtns">
        <button data-size="S" class="secondary btn-slim">S</button>
        <button data-size="M" class="secondary btn-slim">M</button>
        <button data-size="L" class="secondary btn-slim">L</button>
      </div>
    </div>
    <div id="cases" class="cases"></div>
  </section>
</div>

<style>
  .cases { display:grid; gap:8px; }
  @media (min-width: 1000px) { .cases { grid-template-columns: 1fr 1fr; } }
  @media (max-width: 999px) { .cases { grid-template-columns: 1fr; } }
  .casebox { display:grid; grid-template-columns: auto auto; align-items:start; gap:8px; border:1px solid var(--pico-muted-border-color, #ccc); padding:6px; }
  .casebox > .head { grid-column: 1 / -1; font-weight:bold; margin-bottom:4px; display:flex; justify-content:space-between; align-items:center; }
  .case-actions{ display:flex; gap:6px; align-items:center }
  /* Code block: wrap long lines and inherit whitespace in code element */
  #codeBlock pre {
    white-space: pre-wrap;
    overflow-wrap: anywhere;
    word-break: break-word;
    tab-size: 2;
  }
  #codeBlock code { white-space: inherit; }
</style>

<script>
// highlight.js (CDN) loader
function ensureHLJS(cb){
  // Light/Dark theme via media queries
  if(!document.getElementById('hljs-css-light')){
    const l1=document.createElement('link'); l1.id='hljs-css-light'; l1.rel='stylesheet'; l1.href='https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css'; l1.media='(prefers-color-scheme: light)'; document.head.appendChild(l1);
  }
  if(!document.getElementById('hljs-css-dark')){
    const l2=document.createElement('link'); l2.id='hljs-css-dark'; l2.rel='stylesheet'; l2.href='https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css'; l2.media='(prefers-color-scheme: dark)'; document.head.appendChild(l2);
  }
  const onReady = ()=>{
    try{
      if(window.hljs && !window.hljs.getLanguage('python') && !document.getElementById('hljs-lang-python')){
        const lp=document.createElement('script'); lp.id='hljs-lang-python'; lp.src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/languages/python.min.js'; lp.onload=()=>{ cb && cb(); }; document.body.appendChild(lp); return;
      }
    }catch(e){}
    cb && cb();
  };
  if(window.hljs){ onReady(); return; }
  if(document.getElementById('hljs-js')){ const s=document.getElementById('hljs-js'); s.addEventListener('load', onReady, { once:true }); return; }
  const s=document.createElement('script'); s.id='hljs-js'; s.src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.11.1/highlight.min.js'; s.onload=onReady; document.body.appendChild(s);
}
const palette=['#8B00FF','#4B0082','#0000FF','#FFFF00','#00FF00','#FF7F00','#FF0000','#964B00','#000000','#FFFFFF'];
function computeAutoCellPx(containerWidth, maxCols){
  if(!Number.isFinite(containerWidth) || containerWidth<=0 || !Number.isFinite(maxCols) || maxCols<=0) return 12;
  // Consider .mat gap (1px) between cells and .cell border (1px on each side)
  const gap = 1;      // from base.css: .mat { gap:1px }
  const border = 1;   // from base.css: .mat .cell { border:1px }
  const overhead = Math.max(0, (maxCols - 1) * gap + maxCols * 2 * border);
  const avail = Math.max(1, containerWidth - overhead);
  return Math.floor(avail / maxCols);
}
function pickCellPx(containerWidth, maxCols){
  const autoPx = computeAutoCellPx(containerWidth, maxCols);
  // 最大は12。S/M/Lは列数切替に使うためセルは自動サイズのみ。
  return Math.max(1, Math.min(12, autoPx));
}
function drawMatWithCell(mat, cellPx){
  if(!mat || !Array.isArray(mat) || !mat.length || !Array.isArray(mat[0])) return document.createTextNode('');
  const r = mat.length, c = mat[0].length;
  const el = document.createElement('div'); el.className='mat'; el.style.setProperty('--cell', cellPx+'px');
  el.style.gridTemplateColumns = `repeat(${c}, var(--cell))`;
  for(let i=0;i<r;i++){
    for(let j=0;j<c;j++){
      const d=document.createElement('div'); d.className='cell'; d.style.background = palette[mat[i][j]??0]; el.appendChild(d);
    }
  }
  return el;
}
function fmtLen(len,best){ if(len==null||best==null) return '';
  const diff = len-best; return `${len} (${best}${diff>=0?'+':''}${diff})`; }

async function loadTagsStore(){
  try { const r = await fetch('/api/tags'); return await r.json(); } catch { return { all:[], tasks:{} }; }
}
async function loadTaskTags(taskId){
  try { const r = await fetch(`/api/tags/${taskId}`); const j = await r.json(); return j.tags||[]; } catch { return []; }
}
async function saveTaskTags(taskId, tags){
  const r = await fetch('/api/tags/set_for_task', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ task_id: taskId, tags }) });
  return await r.json();
}
async function addTagType(name){
  const r = await fetch('/api/tags/add_type', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
  return await r.json();
}
function renderTagEditor(root, all, current, onChange){
  root.innerHTML='';
  // + chip
  const add = document.createElement('button'); add.className='chip'; add.textContent='＋'; add.title='Add new tag';
  add.onclick=async()=>{
    const name = prompt('New tag name');
    if(!name) return;
    const res = await addTagType(name.trim());
    if(res && res.ok){ all = res.all || all; onChange(current); }
  };
  root.appendChild(add);
  (all||[]).forEach(name=>{
    const b = document.createElement('button'); b.className='chip'; b.textContent=name; b.dataset.tag = name;
    if(current.includes(name)) b.classList.add('contrast');
    b.onclick=()=>{
      const next = current.includes(name) ? current.filter(t=>t!==name) : [...current, name];
      onChange(next);
    };
    // tasksへのフィルター遷移（通常クリックで編集挙動を優先、修飾クリックで遷移）
    b.addEventListener('auxclick', (e)=>{ const tag=e.currentTarget?.dataset?.tag; if(tag){ window.openTasksWithTag(tag); } });
    b.addEventListener('contextmenu', (e)=>{ e.preventDefault(); const tag=e.currentTarget?.dataset?.tag; if(tag){ window.openTasksWithTag(tag); } });
    root.appendChild(b);
  });
}
function renderTagViewer(root, current){
  root.innerHTML='';
  if(!current || !current.length){ const span=document.createElement('span'); span.className='muted'; span.textContent='(no tags)'; root.appendChild(span); return; }
  current.forEach(name=>{
    const b=document.createElement('span'); b.className='chip contrast'; b.textContent=name; b.dataset.tag=name;
    // 閲覧時は編集しない。右クリックや中クリックで tasks のフィルターに飛べるよう維持
    b.addEventListener('auxclick', (e)=>{ const tag=e.currentTarget?.dataset?.tag; if(tag){ window.openTasksWithTag(tag); } });
    b.addEventListener('contextmenu', (e)=>{ e.preventDefault(); const tag=e.currentTarget?.dataset?.tag; if(tag){ window.openTasksWithTag(tag); } });
    root.appendChild(b);
  });
}

(async function(){
  const rootEl = document.getElementById('root');
  const taskId = Number(rootEl?.dataset?.taskId || (location.pathname.match(/\d+$/)||[])[0] || 0);
  const [sum, taskData, store, curr] = await Promise.all([
    fetch('/api/summary').then(r=>r.json()),
    fetch(`/api/task/${taskId}/data`).then(r=>r.json()),
    loadTagsStore(),
    loadTaskTags(taskId)
  ]);
  let allTags = store.all || [];
  let taskTags = Array.isArray(curr)? curr : [];
  const tagRoot = document.getElementById('tagEditor');
  const tagLabel = document.getElementById('tagsLabel');
  let tagsExpanded = (localStorage.getItem('tagsExpanded') === '1');
  async function handleChange(next){
    taskTags = next;
    const res = await saveTaskTags(taskId, taskTags);
    if(res && res.ok){ allTags = res.all || allTags; }
    updateTagsUI();
  }
  function updateTagsUI(){
    if(tagsExpanded){
      if(tagLabel) tagLabel.textContent = 'Tags (editing)';
      renderTagEditor(tagRoot, allTags, taskTags, handleChange);
    }else{
      if(tagLabel) tagLabel.textContent = 'Tags (click here to edit)';
      renderTagViewer(tagRoot, taskTags);
    }
  }
  if(tagLabel){
    tagLabel.addEventListener('click', ()=>{
      tagsExpanded = !tagsExpanded;
      localStorage.setItem('tagsExpanded', tagsExpanded ? '1' : '0');
      updateTagsUI();
    });
  }
  updateTagsUI();

  // Load dist code summary under Overview
  try{
    const r = await fetch(`/api/task/${taskId}/code_summary`);
    const j = await r.json();
    const pre = document.getElementById('codeSummary');
    if(j && j.ok){
      pre.textContent = j.summary || '';
      ensureHLJS(()=>{ try{ window.hljs && window.hljs.highlightElement(pre); }catch(e){} });
    }else{
      pre.textContent = '(no code in dist)';
    }
  }catch(e){ const pre = document.getElementById('codeSummary'); if(pre){ pre.textContent='(failed to load code)'; } }

  const best = sum.bests[taskId-1];
  const len = sum.our_lengths[taskId-1];
  const baseFull = sum.base_path[taskId-1]||'';
  const baseShort = sum.base_short?.[taskId-1] || baseFull;
  const compressor = sum.compressor[taskId-1]||'';
  const message = sum.message[taskId-1]||'';
  const meta = document.getElementById('meta');
  const baseHtml = baseShort ? `<a href="#" class="open-code" data-path="${encodeURIComponent(baseFull)}" title="${baseFull}">${baseShort}</a>` : '-';
  const arcGenUrl = `https://github.com/google/ARC-GEN/blob/main/tasks/training/task${taskId}.py`;
  const arcGenLink = `<a href="${arcGenUrl}" target="_blank" rel="noopener">ARC-GEN</a>`;
  meta.innerHTML = `length: <strong>${fmtLen(len,best) || '-'}</strong> &nbsp;•&nbsp; Base: ${baseHtml} &nbsp;•&nbsp; Compressor: ${compressor||'-'} &nbsp;•&nbsp; Message: ${message||'-'} &nbsp;•&nbsp; ${arcGenLink}`;
  meta.addEventListener('click', async (e)=>{
    const a = e.target.closest('a.open-code'); if(!a) return; e.preventDefault();
    const path = decodeURIComponent(a.dataset.path||''); if(!path) return;
  try{ await fetch('/api/open', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ path }) }); }
    catch(_){}
  });

  function matSize(mat){ const h = (Array.isArray(mat)&&mat.length)||0; const w = (h && Array.isArray(mat[0]) && mat[0].length)||0; return {h,w}; }
  function toListFormat(pair){
    const j = JSON.stringify(pair);
    return j;
  }
  // cases (Overview 内): train/test のみ
  const root = document.getElementById('cases');
  // responsive grid container controlled by S/M/L (S=4, M=3, L=2)
  root.style.display='grid';
  root.style.gap='12px';
  const applyCols=()=>{
    const mode=(localStorage.getItem('gridCols')||'L').toUpperCase();
    const n = mode==='S'?4:(mode==='M'?3:2);
    root.style.gridTemplateColumns = `repeat(${n}, minmax(0, 1fr))`;
  };
  applyCols();
  const addCase = (title, pair)=>{
    const box = document.createElement('div'); box.className='casebox';
    const head = document.createElement('div'); head.textContent = title; head.className='head';
    // Copy button with format selection
    const copyGroup = document.createElement('div'); copyGroup.className='seg';
    const btnInput = document.createElement('button'); btnInput.className='secondary btn-slim'; btnInput.textContent='Input'; btnInput.onclick=()=>{ navigator.clipboard.writeText(JSON.stringify(pair?.input||[])).then(()=>{ window.showAlert('Copied input to clipboard', 'success', 1500); }).catch(()=>{ window.showAlert('Copy failed', 'error', 2000); }); };
    const btnOutput = document.createElement('button'); btnOutput.className='secondary btn-slim'; btnOutput.textContent='Output'; btnOutput.onclick=()=>{ navigator.clipboard.writeText(JSON.stringify(pair?.output||[])).then(()=>{ window.showAlert('Copied output to clipboard', 'success', 1500); }).catch(()=>{ window.showAlert('Copy failed', 'error', 2000); }); };
    const btnBoth = document.createElement('button'); btnBoth.className='secondary btn-slim'; btnBoth.textContent='Both'; btnBoth.onclick=()=>{ navigator.clipboard.writeText(JSON.stringify(pair)).then(()=>{ window.showAlert('Copied case to clipboard', 'success', 1500); }).catch(()=>{ window.showAlert('Copy failed', 'error', 2000); }); };
    copyGroup.appendChild(btnInput); copyGroup.appendChild(btnOutput); copyGroup.appendChild(btnBoth);
    head.appendChild(copyGroup);
    box.appendChild(head);
    const i = document.createElement('div');
    const o = document.createElement('div');
    const isz = matSize(pair?.input); const osz = matSize(pair?.output);
    const isize = document.createElement('div'); isize.className='muted'; isize.style.fontSize='12px'; isize.textContent=`${isz.h} x ${isz.w}`;
    const osize = document.createElement('div'); osize.className='muted'; osize.style.fontSize='12px'; osize.textContent=`${osz.h} x ${osz.w}`;
    const inPlaceholder=document.createElement('div'); const outPlaceholder=document.createElement('div');
    i.appendChild(inPlaceholder); i.appendChild(isize);
    o.appendChild(outPlaceholder); o.appendChild(osize);
    box.appendChild(i); box.appendChild(o);
    root.appendChild(box);
    requestAnimationFrame(()=>{
      const colW = Math.max(1, Math.min(i.clientWidth||0, o.clientWidth||0));
      const maxCols = Math.max(isz.w||0, osz.w||0) || 1;
      const cellPx = pickCellPx(colW, maxCols);
      i.replaceChild(drawMatWithCell(pair?.input, cellPx), inPlaceholder);
      o.replaceChild(drawMatWithCell(pair?.output, cellPx), outPlaceholder);
    });

    // クリックでモーダル拡大（ボタンは除外）
    box.addEventListener('click', (e)=>{
      if(e.target.closest('button') || e.target.closest('.seg')) return;
      const frag = document.createDocumentFragment();
      const cont = document.createElement('div');
      cont.style.display='grid'; cont.style.gridTemplateColumns='1fr 1fr'; cont.style.gap='16px';
      const makePane=(label, mat)=>{
        const wrap=document.createElement('div');
        const h=document.createElement('div'); h.className='muted'; h.style.fontSize='12px'; h.textContent=label; wrap.appendChild(h);
        wrap.appendChild(drawMatWithCell(mat, 13));
        return wrap;
      };
      cont.appendChild(makePane('input', pair?.input));
      cont.appendChild(makePane('output', pair?.output));
      frag.appendChild(cont);
      window.showModal(frag);
    });
  };
  (taskData.train||[]).forEach((t,i)=>addCase(`train_${i}`, t));
  (taskData.test||[]).forEach((t,i)=>addCase(`test_${i}`, t));
  // skip arc-gen in overview

  // progress chart
  const prog = await fetch(`/api/task/${taskId}/progress`).then(r=>r.json());
  const teams = (prog.teams || []).map(t=>({
    name: t.name,
    series: (t.series||[]).filter(p=> p && p.score!=null && typeof p.score === 'number')
  })).filter(t=> t.series.length);
  const colors = teams.map((_,i)=>`hsl(${(i*47)%360} 70% 50%)`);
  const series = teams.map((t,i)=>({ name:t.name, color:colors[i], data:t.series }));
  let currentBest = Infinity; series.forEach(s=>{ if(s.data && s.data.length){ const last = s.data[s.data.length-1].score; if(last<currentBest) currentBest=last; } }); if(!isFinite(currentBest)) currentBest = null;

  const chartWrap = document.getElementById('chartWrap');
  const chart = document.getElementById('chart'); const ctx = chart.getContext('2d'); const overlay = document.getElementById('overlay'); overlay.width = chart.width; overlay.height = chart.height; const octx = overlay.getContext('2d');
  function drawChart(){
    const width = chart.clientWidth || chart.width; const height = chart.height; chart.width = width; overlay.width = width; overlay.height = height; ctx.clearRect(0,0,width,height); octx.clearRect(0,0,width,height);
    const styles = getComputedStyle(document.documentElement); const fg = styles.getPropertyValue('--muted-color').trim() || '#666'; const gridCol = 'rgba(127,127,127,0.25)';
    const allPoints = series.flatMap(s=>s.data||[]);
    // X range: first point to now
    const xs = allPoints.map(p=>p.t);
    const nowSec = Math.floor(Date.now()/1000);
    const minX = xs.length? Math.min(...xs) : nowSec - 86400;
    const maxX = nowSec;
    const ys = allPoints.map(p=>p.score).filter(v=> typeof v==='number' && !isNaN(v));
    const minY = 0; const maxY = Math.min(Math.max( (ys.length? Math.max(...ys): (best||0)), best||0, len||0 ) * 1.1 + 5, (best||0)*2+10);
    const pad = {l:64,r:12,t:8,b:28}; const x2px = x=> pad.l + ( (x-minX) / (maxX-minX || 1) ) * (width - pad.l - pad.r); const y2px = y=> height - pad.b - ( (y-minY) / (maxY-minY || 1) ) * (height - pad.t - pad.b);
    // Y grid
    ctx.fillStyle = fg; ctx.font = '12px ui-sans-serif, system-ui, sans-serif'; ctx.textAlign='right'; ctx.strokeStyle=gridCol; ctx.lineWidth=1;
    const yStep = Math.max(1, Math.round((maxY-minY)/6));
    for(let y=minY; y<=maxY; y+=yStep){ const py=y2px(y); ctx.beginPath(); ctx.moveTo(pad.l, py); ctx.lineTo(width-pad.r, py); ctx.stroke(); ctx.fillText(String(Math.round(y)), pad.l-6, py+4); }
    // X grid weekly ticks with date labels (YYYY-MM-DD)
    const week = 7*86400; let t0 = Math.floor(minX / week) * week;
    ctx.textAlign='center';
    for(let t=t0; t<=maxX; t+=week){ const px=x2px(t); ctx.strokeStyle=gridCol; ctx.beginPath(); ctx.moveTo(px, height-pad.b); ctx.lineTo(px, pad.t); ctx.stroke(); const d=new Date(t*1000); const lab=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; ctx.fillText(lab, px, height-6); }
    if(currentBest!=null){ octx.strokeStyle = 'red'; octx.setLineDash([6,4]); octx.lineWidth = 1.5; octx.beginPath(); octx.moveTo(pad.l, y2px(currentBest)); octx.lineTo(width-pad.r, y2px(currentBest)); octx.stroke(); octx.setLineDash([]); }
    // series step-lines
    series.forEach(s=>{ if(!s.data||!s.data.length) return; ctx.strokeStyle = s.color; ctx.lineWidth = 2; ctx.beginPath(); let prev = s.data[0]; ctx.moveTo(x2px(prev.t), y2px(prev.score)); for(let i=1;i<s.data.length;i++){ const p=s.data[i]; ctx.lineTo(x2px(p.t), y2px(prev.score)); ctx.lineTo(x2px(p.t), y2px(p.score)); prev=p; } ctx.stroke(); ctx.fillStyle=s.color; s.data.forEach(p=>{ ctx.beginPath(); ctx.arc(x2px(p.t), y2px(p.score), 4, 0, Math.PI*2); ctx.fill(); }); });
    // legend rebuild
    const pl = document.getElementById('progLegend'); pl.innerHTML=''; series.forEach(s=>{ const last = s.data && s.data.length ? s.data[s.data.length-1].score : null; const item = document.createElement('span'); item.style.display='inline-flex'; item.style.alignItems='center'; item.style.gap='6px'; item.innerHTML = `<span style="width:12px;height:12px;background:${s.color};border:1px solid rgba(0,0,0,0.2);"></span>${s.name}${last!=null?` <small>(${last})</small>`:''}`; pl.appendChild(item); });
  }
  window.addEventListener('resize', drawChart);
  const tt=document.getElementById('tooltip'); chart.addEventListener('mousemove', (e)=>{ const chartRect = chart.getBoundingClientRect(); const wrapRect = chartWrap.getBoundingClientRect(); const x=e.clientX-chartRect.left, y=e.clientY-chartRect.top; const width=chart.width, height=chart.height; const pad={l:64,r:12,t:8,b:28}; const allPoints = series.flatMap(s=>s.data||[]); const xs = allPoints.map(p=>p.t); const nowSec=Math.floor(Date.now()/1000); const minX = xs.length? Math.min(...xs) : nowSec-86400; const maxX = nowSec; const ys = allPoints.map(p=>p.score).filter(v=> typeof v==='number' && !isNaN(v)); const minY = 0; const maxY = Math.max( (ys.length? Math.max(...ys): (best||0)), best||0, len||0 ) * 1.1 + 5; const x2px = x=> pad.l + ( (x-minX) / (maxX-minX || 1) ) * (width - pad.l - pad.r); const y2px = y=> height - pad.b - ( (y-minY) / (maxY-minY || 1) ) * (height - pad.t - pad.b); let found=null, dmin=10; series.forEach(s=>{ (s.data||[]).forEach(p=>{ const px = x2px(p.t), py=y2px(p.score); const d=Math.hypot(px-x, py-y); if(d<dmin){ dmin=d; found={s,p,px,py}; } }); }); if(found){ tt.style.display='block'; tt.textContent = `${found.s.name}: ${found.p.score}`; tt.style.left = (found.px + 12 + chartRect.left - wrapRect.left) + 'px'; tt.style.top = (found.py - 10 + chartRect.top - wrapRect.top) + 'px'; } else { tt.style.display='none'; } }); chart.addEventListener('mouseleave', ()=> tt.style.display='none');
  drawChart();
})();

// size buttons (S/M/L = 列数切替)
document.addEventListener('DOMContentLoaded', ()=>{
  const seg = document.getElementById('sizeBtns'); if(!seg) return;
  const applyActive=(v)=>{ [...seg.querySelectorAll('button')].forEach(b=> b.classList.toggle('contrast', b.dataset.size===v)); };
  const cur=(localStorage.getItem('gridCols')||'L').toUpperCase(); applyActive(cur);
  seg.addEventListener('click', (e)=>{ const v=e.target.closest('button')?.dataset.size; if(!v) return; localStorage.setItem('gridCols', v); applyActive(v); location.reload(); });

  // resizeで再計算（モーダル表示中は抑制）
  let t; window.addEventListener('resize', ()=>{ if(window.__modalOpen) return; if(window.__modalSuppressReloadUntil && Date.now() < window.__modalSuppressReloadUntil) return; clearTimeout(t); t=setTimeout(()=> location.reload(), 150); });
});

document.getElementById('btnInit').addEventListener('click', async function(){
  const rootEl = document.getElementById('root');
  const taskId = Number(rootEl?.dataset?.taskId || (location.pathname.match(/\d+$/)||[])[0] || 0);
  try{
    const r = await fetch(`/api/task/${taskId}/init`, { method:'POST' });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||'init failed');
    const msg = j.created ? 'created file' : 'prepended banner';
    window.showAlert(`Initialized: ${msg}<br/><small>${j.path}</small>`, 'success', 3000);
  }catch(e){
    window.showAlert(`Init failed: ${e?.message||e}`, 'error', 4000);
  }
});
</script>
{% endblock %}
