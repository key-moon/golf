{% extends "base.html" %}
{% block title %}Tasks - ARC-AGI Golf{% endblock %}
{% block content %}
<h2>Tasks</h2>
<div class="grid cols-4">
  <div>
    <strong>View</strong><br/>
    <div id="viewBtns" class="seg">
      <button data-view="thumb" title="Thumbnail" class="secondary">üñºÔ∏è</button>
      <button data-view="list" title="List" class="secondary">üìã</button>
    </div>
  </div>
  <div>
    <strong>Sort</strong><br/>
    <div id="sortBtns" class="seg">
      <button data-sort="problem" class="secondary">problem</button>
      <button data-sort="best" class="secondary">best</button>
      <button data-sort="length" class="secondary">length</button>
      <button data-sort="diff" class="secondary">diff</button>
    </div>
  </div>
  <div>
    <strong>Order</strong><br/>
    <div id="orderBtns" class="seg">
      <button data-order="asc" class="secondary">asc</button>
      <button data-order="desc" class="secondary">desc</button>
    </div>
  </div>
  <div>
    <strong>Show</strong><br/>
    <div id="showBtns" class="seg">
      <button data-show="input" class="secondary">input</button>
      <button data-show="output" class="secondary">output</button>
      <button data-show="both" class="secondary">both</button>
    </div>
  </div>
  <div>
    <strong>Cell size</strong><br/>
    <div id="sizeBtns" class="seg">
      <button data-size="lg" class="secondary">L</button>
      <button data-size="md" class="secondary">M</button>
      <button data-size="sm" class="secondary">S</button>
    </div>
  </div>
  <div>
    <strong>Grid tags</strong><br/>
    <div id="gridTagsBtns" class="seg">
      <button data-gt="off" class="secondary">off</button>
      <button data-gt="on" class="secondary">on</button>
    </div>
  </div>
</div>

<div style="margin-top:8px; display:flex; gap:12px; align-items:center; flex-wrap:wrap">
  <div>
    <strong>Tags filter (OR)</strong><br/>
    <div id="tagFilter" class="chips" style="display:flex; gap:6px; flex-wrap:wrap"></div>
  </div>
</div>

<div id="list"></div>
<script>
const palette=['#8B00FF','#4B0082','#0000FF','#FFFF00','#00FF00','#FF7F00','#FF0000','#964B00','#000000','#FFFFFF'];
let THUMBS_CACHE=null, THUMBS_CACHE_WITH_OUT=null;
let TAGS_STORE=null; // { all: string[], tasks: { [taskId]: string[] } }
let SELECTED_TAGS=[];
let GRID_TAGS='off';
function applyActive(group, value, attr){
  if(!group) return;
  [...group.querySelectorAll('button')].forEach(b=>{
    b.classList.toggle('contrast', b.dataset[attr]===value);
  });
}
function getDiffStyles(diff, base=0.18, ratio=90, crop=0.9){
  if(diff==null || isNaN(diff)) return { bg:'', outline:'' };
  const opacity = Math.min(base + Math.abs(diff)/ratio, crop)
  //                     0  5 10 15 20 25 30 35
  const stropePalette = [0, 2, 5, 5, 8, 8,12,12];
  const stroke = stropePalette[Math.min(Math.floor(Math.abs(diff)/5), stropePalette.length - 1)];
  // Áü≠Á∏ÆÔºàËâØ„ÅÑÔºâÂÅ¥: Á∑ë
  if (diff === 0) return { bg:'', outline:'' };
  if (diff < 0) return { bg:`rgba(0,160,0,${opacity})`, outline:`${stroke}px solid rgba(0,140,0,0.95)` };
  if (diff > 0) return { bg:`rgba(220,0,0,${opacity})`, outline:`${stroke}px solid rgba(200,0,0,0.95)` };
}
function applyDiffStyles(el, diff){
  const s = getDiffStyles(diff);
  el.style.background = s.bg || '';
  el.style.outline = s.outline || 'none';
  el.style.outlineOffset = '0px';
}
// listÁî®: Ë°åÂÖ®‰Ωì„Å´ËÉåÊôØ„Å®Â§™Êû†Ôºàbox-shadowÔºâ„ÇíÈÅ©Áî®„Åó„ÄÅÂêÑ„Çª„É´„Å´„ÇÇËÉåÊôØ„ÇíÂèçÊò†
function applyDiffStylesRow(tr, diff){
  const s = getDiffStyles(diff, 0.05, 150, 0.4);
  tr.style.background = s.bg || '';
  const tds = tr.querySelectorAll('td, th');
  tds.forEach(td=>{ td.style.background = s.bg || ''; });
  // Â∑¶ÂÅ¥„Å†„ÅëÂ§™Á∑öÔºàÊúÄÂàù„ÅÆ„Çª„É´„Å´ÈÅ©Áî®Ôºâ
  const first = tr.querySelector('td, th');
  if(first){
    if(s.outline){
      const m = s.outline.match(/(\d+(?:\.\d+)?)px\s+solid\s+(.+)/);
      if(m){ const w = parseFloat(m[1])*2; const col = m[2]; first.style.boxShadow = `inset ${w}px 0 0 0 ${col}`; }
    } else {
      first.style.borderLeft = 'none';
    }
  }
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[c])); }
async function loadTagsStore(){
  if(TAGS_STORE) return TAGS_STORE;
  TAGS_STORE = await fetch('/api/tags').then(r=>r.json()).catch(()=>({all:[], tasks:{}}));
  TAGS_STORE.all = Array.isArray(TAGS_STORE.all)? TAGS_STORE.all : [];
  TAGS_STORE.tasks = TAGS_STORE.tasks && typeof TAGS_STORE.tasks==='object'? TAGS_STORE.tasks : {};
  return TAGS_STORE;
}
// Parse tags from URLSearchParams. Prefer repeated ?tags=.. entries; fallback to legacy CSV.
function parseTagsParamFromParams(params){
  if(!params) return [];
  const arr = (params.getAll ? params.getAll('tags') : []).map(s=>s.trim()).filter(Boolean);
  if(arr.length) return arr;
  const legacy = params.get ? params.get('tags') : null;
  if(!legacy) return [];
  return legacy.split(',').map(s=>s.trim()).filter(Boolean);
}
function updateTagsParam(){
  const params = new URLSearchParams(location.search);
  // Remove all existing 'tags' first, then append each to avoid delimiter issues
  params.delete('tags');
  SELECTED_TAGS.forEach(t=> params.append('tags', t));
  if(!SELECTED_TAGS.length) params.delete('tags');
  history.replaceState(null,'',`?${params.toString()}`);
}
function renderTagFilter(){
  const root = document.getElementById('tagFilter'); if(!root || !TAGS_STORE) return;
  root.innerHTML='';
  // Clear chip
  const clear = document.createElement('button'); clear.className='chip'; clear.textContent='Clear'; clear.onclick=()=>{ SELECTED_TAGS=[]; updateTagsParam(); render(); };
  root.appendChild(clear);
  (TAGS_STORE.all||[]).forEach(name=>{
    const b = document.createElement('button'); b.className='chip'; b.textContent=name; if(SELECTED_TAGS.includes(name)) b.classList.add('contrast');
    b.onclick=()=>{
      if(SELECTED_TAGS.includes(name)) SELECTED_TAGS = SELECTED_TAGS.filter(t=>t!==name); else SELECTED_TAGS = [...SELECTED_TAGS, name];
      updateTagsParam(); renderTagFilter(); render();
    };
    root.appendChild(b);
  });
}
(function initControls(){
  const params = new URLSearchParams(location.search);
  const view = params.get('view')||'thumb';
  const sort = params.get('sort')||'best';
  const order = params.get('order')||'asc';
  const show = params.get('show')||'both';
  const size = params.get('size')||'md';
  SELECTED_TAGS = parseTagsParamFromParams(params);
  GRID_TAGS = params.get('gt')||'off';
  const setParam=(k,v)=>{ params.set(k,v); history.replaceState(null,'',`?${params.toString()}`); render(); };
  const viewBtns=document.getElementById('viewBtns'); applyActive(viewBtns, view, 'view'); viewBtns.onclick=(e)=>{ const v=e.target.closest('button')?.dataset.view; if(v){ applyActive(viewBtns, v, 'view'); setParam('view', v); } };
  const sortBtns=document.getElementById('sortBtns'); applyActive(sortBtns, sort, 'sort'); sortBtns.onclick=(e)=>{ const v=e.target.closest('button')?.dataset.sort; if(v){ applyActive(sortBtns, v, 'sort'); setParam('sort', v); } };
  const orderBtns=document.getElementById('orderBtns'); applyActive(orderBtns, order, 'order'); orderBtns.onclick=(e)=>{ const v=e.target.closest('button')?.dataset.order; if(v){ applyActive(orderBtns, v, 'order'); setParam('order', v); } };
  const showBtns=document.getElementById('showBtns'); applyActive(showBtns, show, 'show'); showBtns.onclick=(e)=>{ const v=e.target.closest('button')?.dataset.show; if(v){ applyActive(showBtns, v, 'show'); setParam('show', v); } };
  const sizeBtns=document.getElementById('sizeBtns'); applyActive(sizeBtns, size, 'size'); sizeBtns.onclick=(e)=>{ const v=e.target.closest('button')?.dataset.size; if(v){ applyActive(sizeBtns, v, 'size'); setParam('size', v); } };
  const gtBtns=document.getElementById('gridTagsBtns'); applyActive(gtBtns, GRID_TAGS, 'gt'); gtBtns.onclick=(e)=>{ const v=e.target.closest('button')?.dataset.gt; if(v){ applyActive(gtBtns, v, 'gt'); params.set('gt', v); history.replaceState(null,'',`?${params.toString()}`); render(); } };
})();

async function getThumbs(includeOutput){
  if(includeOutput){ if(!THUMBS_CACHE_WITH_OUT) THUMBS_CACHE_WITH_OUT = await (await fetch('/api/tasks/thumbs?include_output=1')).json(); return THUMBS_CACHE_WITH_OUT; }
  else { if(!THUMBS_CACHE) THUMBS_CACHE = await (await fetch('/api/tasks/thumbs')).json(); return THUMBS_CACHE; }
}

async function render(){
  const params = new URLSearchParams(location.search);
  const view = params.get('view')||'thumb';
  const sort = params.get('sort')||'best';
  const order = params.get('order')||'asc';
  const show = params.get('show')||'both';
  const size = params.get('size')||'md';
  GRID_TAGS = params.get('gt')||'off';
  // ensure tags loaded and filter UI rendered
  await loadTagsStore();
  const urlTags = parseTagsParamFromParams(params);
  SELECTED_TAGS = urlTags.length ? urlTags : SELECTED_TAGS;
  renderTagFilter();

  // update active states
  applyActive(document.getElementById('viewBtns'), view, 'view');
  applyActive(document.getElementById('sortBtns'), sort, 'sort');
  applyActive(document.getElementById('orderBtns'), order, 'order');
  applyActive(document.getElementById('showBtns'), show, 'show');
  applyActive(document.getElementById('sizeBtns'), size, 'size');

  const s = await (await fetch('/api/summary')).json();
  const thumbs = await getThumbs(show!=='input'); // both/output require output

  let rows = [];
  for(let i=1;i<=400;i++){
    const best = s.bests[i-1];
    const len = s.our_lengths[i-1];
    const diff = (best!=null && len!=null) ? (len-best) : null;
    const t = thumbs[i-1]||{};
    const base_full = s.base_path?.[i-1] || '';
    const base = s.base_short?.[i-1] || base_full;
    const tags = (TAGS_STORE?.tasks?.[String(i)] || []).slice();
    rows.push({ id:i, best, len, diff, input:t.input, output:t.output, base, base_full, compressor:s.compressor[i-1]||'', message:s.message[i-1]||'', tags });
  }
  // OR filter by selected tags
  if(SELECTED_TAGS.length){
    rows = rows.filter(r=> (r.tags||[]).some(t=> SELECTED_TAGS.includes(t)) );
  }
  const cmpNumber = (av,bv)=>{
    if(av==null&&bv==null) return 0;
    if(av==null) return 1;
    if(bv==null) return -1;
    return av-bv;
  };
  const cmpKey=(k)=> (a,b)=> cmpNumber(a[k], b[k]);
  if(sort!=="problem"){
    if(sort==="length") rows.sort(cmpKey('len'));
    else if(sort==="best") rows.sort(cmpKey('best'));
    else if(sort==="diff") rows.sort(cmpKey('diff'));
  }
  if(order==="desc") rows.reverse();

  const list = document.getElementById('list');
  list.innerHTML='';

  if(view==='list'){
    const table = document.createElement('table');
    table.innerHTML = '<thead><tr><th>ID</th><th>length</th><th>best</th><th>Base</th><th>Compressor</th><th>Message</th><th>Tags</th></tr></thead>';
    const tb = document.createElement('tbody');
    rows.forEach(r=>{
      const tr=document.createElement('tr');
      const lengthLabel = (r.len!=null && r.best!=null && r.diff!=null) ? `${r.len} (${r.best}${r.diff>=0?'+':''}${r.diff})` : (r.len??'');
      const baseCell = r.base ? `<a href="#" class="open-code" data-path="${encodeURIComponent(r.base_full)}" title="${r.base_full}">${r.base}</a>` : '';
      const tagsHtml = (r.tags||[]).map(t=>`<button class="chip tag-link" data-tag-enc="${encodeURIComponent(t)}">${escapeHtml(t)}</button>`).join(' ');
      tr.innerHTML = `<td><a href="/tasks/${r.id}">task${String(r.id).padStart(3,'0')}</a></td><td>${lengthLabel}</td><td>${r.best??''}</td><td class="nowrap">${baseCell}</td><td class="nowrap" title="${r.compressor}">${r.compressor||''}</td><td class="nowrap" title="${r.message}">${r.message||''}</td><td class="nowrap">${tagsHtml}</td>`;
      applyDiffStylesRow(tr, r.diff);
      tb.appendChild(tr);
    });
    table.appendChild(tb);
    list.appendChild(table);
    // delegate click for open-code and tag-link
    list.onclick = async (e)=>{
      const a = e.target.closest('a.open-code');
      if(a){
        e.preventDefault();
        const path = decodeURIComponent(a.dataset.path||'');
        if(path){
          try{ await fetch('/api/open', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ path }) }); }catch(_){ }
        }
        return;
      }
      const chip = e.target.closest('button.tag-link');
      if(chip){ const enc = chip.dataset.tagEnc; const tag = enc ? decodeURIComponent(enc) : chip.dataset.tag; if(tag){ window.openTasksWithTag(tag); } }
    };
  } else {
    const grid = document.createElement('div');
    // columns by size: L=5, M=6(„Éá„Éï„Ç©„É´„Éà„ÅÆ„Åæ„Åæ), S=9
    grid.className = 'grid';
    const cols = size==='lg' ? 5 : size==='sm' ? 9 : 6;
    grid.style.gridTemplateColumns = `repeat(${cols}, minmax(0,1fr))`;
    // Now: previous S becomes new L; provide smaller M,S
    const dims = size==='lg' ? {w:120,h:90} : size==='md' ? {w:90,h:68} : {w:60,h:45};
    rows.forEach(r=>{
      const card = document.createElement('a'); card.className='thumb'; card.href=`/tasks/${r.id}`; card.style.textDecoration='none'; card.style.color='inherit';
      applyDiffStyles(card, r.diff);
      const lengthLabel = (r.len!=null && r.best!=null && r.diff!=null) ? `${r.len} (${r.best}${r.diff>=0?'+':''}${r.diff})` : (r.len??'-');
      const meta = document.createElement('div');
      const showLen = size!=='sm';
      const tagsHtml = GRID_TAGS==='on' ? `<div style="display:flex; gap:4px; flex-wrap:wrap; margin-top:4px">${(r.tags||[]).map(t=>`<button class='chip tag-link' data-tag-enc='${encodeURIComponent(t)}' onclick='event.preventDefault(); window.openTasksWithTag(${JSON.stringify(t)})'>${escapeHtml(t)}</button>`).join(' ')}</div>` : '';
      meta.innerHTML = `<strong>task${String(r.id).padStart(3,'0')}</strong>${showLen?`<br/><small>length: ${lengthLabel}</small>`:''}${tagsHtml}`;
      card.appendChild(meta);
      const thumbWrap = document.createElement('div');
      thumbWrap.style.flex='0 0 auto';
      thumbWrap.style.marginTop='auto';
      if(show==='both'){
        thumbWrap.style.display='grid'; thumbWrap.style.gridTemplateColumns='1fr 1fr'; thumbWrap.style.gap='6px';
        const cnv1 = document.createElement('canvas'); const cnv2 = document.createElement('canvas');
        ;[cnv1,cnv2].forEach(c=>{ c.width=dims.w; c.height=dims.h; c.style.width=dims.w+'px'; c.style.height=dims.h+'px'; });
        try { drawThumbFromData(r.input, cnv1); } catch(e) {}
        try { drawThumbFromData(r.output, cnv2); } catch(e) {}
        thumbWrap.appendChild(cnv1); thumbWrap.appendChild(cnv2);
      } else {
        const cnv = document.createElement('canvas'); cnv.width=dims.w; cnv.height=dims.h; cnv.style.width=dims.w+'px'; cnv.style.height=dims.h+'px';
        try { drawThumbFromData((show==='output'?r.output:r.input), cnv); } catch(e) {}
        thumbWrap.appendChild(cnv);
      }
      card.appendChild(thumbWrap);
      grid.appendChild(card);
    });
    list.appendChild(grid);
  }
}

function drawThumbFromData(mat, cnv){
  if(!mat || !Array.isArray(mat) || !mat.length || !Array.isArray(mat[0])) return;
  const r = mat.length, c = mat[0].length;
  const ctx = cnv.getContext('2d');
  const scale = Math.max(1, Math.floor(Math.min(cnv.width/c, cnv.height/r)));
  cnv.width = c*scale; cnv.height = r*scale;
  for(let i=0;i<r;i++) for(let j=0;j<c;j++){
    const v = mat[i][j];
    const col = palette[v==null?0:v];
    ctx.fillStyle = col;
    ctx.fillRect(j*scale, i*scale, scale, scale);
    ctx.strokeStyle = 'rgba(0,0,0,0.25)';
    ctx.strokeRect(j*scale, i*scale, scale, scale);
  }
}

render();
</script>
{% endblock %}
