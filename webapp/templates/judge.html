{% extends "base.html" %}
{% block title %}Judge Viewer - ARC-AGI Golf{% endblock %}
{% block content %}
<div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:8px">
  <label><input type="checkbox" id="chkAll"> Show all cases</label>
  <button id="btnReload" class="secondary btn-slim">Reload (R)</button>
  <span id="status" class="muted"></span>
  <span id="pagerTop" style="margin-left:auto"></span>
</div>
<div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin: 4px 0 8px">
  <div class="seg" id="sizeBtns">
    <button data-size="S" class="secondary btn-slim">S</button>
    <button data-size="M" class="secondary btn-slim">M</button>
    <button data-size="L" class="secondary btn-slim">L</button>
  </div>
  <label class="muted" style="display:inline-flex; align-items:center; gap:6px">
    <span>cell</span>
    <input id="cellPxInput" type="number" min="1" max="64" inputmode="numeric" style="width:64px; height:28px; padding:2px 6px" placeholder="max">
    <span class="muted" style="font-size:12px">px (max)</span>
  </label>
  <span id="taskLinks" class="muted"></span>
  <span style="margin-left:auto"></span>
</div>
<div id="list" style="display:flex; flex-direction:column; gap:12px"></div>
<div id="pagerBottom" style="display:flex; justify-content:flex-end; margin-top:8px"></div>

<style>
  /* Responsive grid for a case row: 4 → 3 (dumps below) → 2 → 1 */
  .case-grid{ display:grid; gap:12px; grid-template-columns: repeat(4, minmax(200px, 1fr)); }
  /* 3 columns: dumps spans full row */
  @media (max-width: 1400px){
    .case-grid{ grid-template-columns: repeat(3, minmax(200px, 1fr)); }
    .case-grid .col-dumps{ grid-column: 1 / -1; }
  }
  /* 2 columns */
  @media (max-width: 1000px){ .case-grid{ grid-template-columns: repeat(2, minmax(180px, 1fr)); } }
  /* 1 column */
  @media (max-width: 700px){ .case-grid{ grid-template-columns: 1fr; } }
  .case-col-body{ overflow:auto; max-width:100%; }
  .case-pre{ margin:0; overflow:auto; max-width:100%; }
  /* dumps block: remove vertical margins and tone down summary */
  .col-dumps{ margin-block: 0; }
  .col-dumps details{ margin: 0; padding: 0; }
  .col-dumps summary{ margin: 0; padding: 0; font-size: 12px; font-weight: 400; color: var(--pico-muted-color, #666); cursor: pointer; }
</style>

<script>
const palette=['#8B00FF','#4B0082','#0000FF','#FFFF00','#00FF00','#FF7F00','#FF0000','#964B00','#000000','#FFFFFF'];
let LAST_MTIME = 0;
const PAGE_SIZE = 10;
const SIZE_KEY = 'gridSize';
function getPrefCell(){
  const manual = parseInt(localStorage.getItem('cellPxManual')||'', 10);
  if(Number.isFinite(manual) && manual>0) return manual;
  const k=(localStorage.getItem(SIZE_KEY)||'L').toUpperCase(); return k==='S'?5: (k==='M'?7:10);
}
function setCellKey(k){ localStorage.setItem(SIZE_KEY, k); applyActive(document.getElementById('sizeBtns'), k, 'size'); }
function applyActive(group, value, attr){ if(!group) return; [...group.querySelectorAll('button')].forEach(b=>b.classList.toggle('contrast', b.dataset[attr]===String(value))); }

function isMatrixLike(x){
  if(!Array.isArray(x) || x.length===0) return false;
  if(!Array.isArray(x[0])) return false;
  const w = x[0].length;
  for(const row of x){ if(!Array.isArray(row) || row.length!==w) return false; }
  return true;
}

function drawMat(el, mat, opts={}){
  const cell = opts.cell || getPrefCell();
  if(!isMatrixLike(mat)) return false;
  el.className='mat';
  el.style.setProperty('--cell', cell+'px');
  el.style.display='grid';
  const cols = mat[0].length;
  el.style.gridTemplateColumns=`repeat(${cols}, var(--cell))`;
  el.dataset.cols = String(cols);
  el.innerHTML='';
  for(let i=0;i<mat.length;i++){
    for(let j=0;j<mat[i].length;j++){
      const v = mat[i][j];
      const cellEl = document.createElement('div');
      cellEl.className='cell';
      cellEl.style.width='var(--cell)';
      cellEl.style.height='var(--cell)';
      cellEl.style.display='flex';
      cellEl.style.alignItems='center';
      cellEl.style.justifyContent='center';
      cellEl.style.fontFamily='ui-monospace, SFMono-Regular, Menlo, monospace';
      cellEl.style.fontSize = Math.max(10, Math.floor(cell*0.6))+'px';
      cellEl.style.lineHeight='1';
      let idx = null;
      if(typeof v==='boolean') idx = v?1:0;
      else if(Number.isInteger(v)) idx = v;
      const valid = (idx!==null && idx>=0 && idx<palette.length);
      cellEl.style.background = valid ? palette[idx] : 'transparent';
      if(!valid){
        let txt;
        if(typeof v==='string') txt=v;
        else if(v===null) txt='null';
        else if(v===undefined) txt='undef';
        else txt=String(v);
        cellEl.textContent = txt.length>3 ? txt.slice(0,3) : txt;
        cellEl.style.color='red';
        cellEl.style.border='1px solid rgba(255,0,0,0.6)';
        cellEl.title = String(v);
      }
      el.appendChild(cellEl);
    }
  }
  return true;
}

function dumpJsonCustom(x){
  if(Array.isArray(x) && x.every(e=> !Array.isArray(e))){
    return '[' + x.map(v=> typeof v==='string' ? JSON.stringify(v) : String(v)).join(', ') + ']';
  }
  try{ return JSON.stringify(x, null, 2);}catch{ return String(x); }
}

function hasDumps(d){
  if(d == null) return false;
  if(typeof d === 'string') return d.length > 0;
  if(Array.isArray(d)) return d.length > 0;
  if(typeof d === 'object') return Object.keys(d).length > 0;
  return false;
}

function renderDumpsColumn(container, dumps){
  const wrap = document.createElement('div');
  wrap.style.marginTop='0'; wrap.style.marginBottom='0';

  // アコーディオン本体（summaryを見出しとして統合・控えめに）
  const details = document.createElement('details');
  details.style.margin='0'; details.style.padding='0';
  const summary = document.createElement('summary');
  summary.textContent = 'dumps';
  summary.className = 'muted';
  summary.style.cursor='pointer';
  summary.style.margin='0'; summary.style.padding='0';
  summary.style.fontSize='12px'; summary.style.fontWeight='400';
  details.appendChild(summary);

  const list = document.createElement('div'); list.className='dumps-list';
  list.style.display='grid';
  list.style.gridTemplateColumns='repeat(auto-fill, minmax(140px, 1fr))';
  list.style.gap='8px';

  const appendEntry = (label, value)=>{
    const box = document.createElement('div');
    box.style.border='1px solid #ddd'; box.style.borderRadius='6px'; box.style.padding='6px';
    const cap = document.createElement('div'); cap.className='muted'; cap.style.fontSize='12px'; cap.textContent=label; box.appendChild(cap);
    const body = document.createElement('div'); body.className='case-col-body';
    if(typeof value==='string'){
      const pre=document.createElement('pre'); pre.className='case-pre'; pre.textContent=value; body.appendChild(pre);
      }else if(isMatrixLike(value)){
        const m=document.createElement('div'); drawMat(m, value); body.appendChild(m);
    }else{
      const pre=document.createElement('pre'); pre.className='case-pre'; pre.textContent=dumpJsonCustom(value); body.appendChild(pre);
    }
    box.appendChild(body); list.appendChild(box);
  };

  if(dumps!=null){
    if(typeof dumps==='string') appendEntry('text', dumps);
    else if(Array.isArray(dumps)) dumps.forEach((v,i)=> appendEntry(`#${i}`, v));
    else if(typeof dumps==='object'){ Object.keys(dumps).forEach(k=> appendEntry(k, dumps[k])); }
  }

  details.appendChild(list);
  wrap.appendChild(details);
  container.appendChild(wrap);
}

function renderCaseRow(item){
  const caze = item.case, casenum = item.casenum, output = item.output, dumps = item.dumps, verdict = item.verdict;
  const card = document.createElement('article');
  card.style.border='1px solid #e5e5e5'; card.style.borderRadius='8px'; card.style.padding='8px';

  const head = document.createElement('div');
  head.style.display='flex'; head.style.justifyContent='space-between'; head.style.alignItems='center'; head.style.marginBottom='6px';
  const badge = verdict? '<span style="color:#0a0">OK</span>' : '<span style="color:#a00">NG</span>';
  const leftTitle = document.createElement('strong'); leftTitle.textContent = `#${casenum}`;
  const headRight = document.createElement('div'); headRight.style.display='flex'; headRight.style.gap='8px'; headRight.style.alignItems='center';
  const copySeg = document.createElement('div'); copySeg.className='seg';
  const bIn=document.createElement('button'); bIn.className='secondary btn-slim'; bIn.textContent='input'; bIn.onclick=()=> navigator.clipboard.writeText(JSON.stringify(caze?.input??[])).then(()=>window.showAlert('Copied input','success',1200)).catch(()=>window.showAlert('Copy failed','error',1500));
  const bEx=document.createElement('button'); bEx.className='secondary btn-slim'; bEx.textContent='expected'; bEx.onclick=()=> navigator.clipboard.writeText(JSON.stringify(caze?.output??[])).then(()=>window.showAlert('Copied expected','success',1200)).catch(()=>window.showAlert('Copy failed','error',1500));
  const bAc=document.createElement('button'); bAc.className='secondary btn-slim'; bAc.textContent='actual'; bAc.onclick=()=> navigator.clipboard.writeText(JSON.stringify(output)).then(()=>window.showAlert('Copied actual','success',1200)).catch(()=>window.showAlert('Copy failed','error',1500));
  copySeg.appendChild(bIn); copySeg.appendChild(bEx); copySeg.appendChild(bAc);
  const verdictSpan = document.createElement('span'); verdictSpan.className='muted'; verdictSpan.innerHTML = badge;
  headRight.appendChild(copySeg); headRight.appendChild(verdictSpan);
  head.appendChild(leftTitle); head.appendChild(headRight);
  card.appendChild(head);

  // Responsive 4 columns: input / expected / actual / dumps
  const grid = document.createElement('div');
  grid.className='case-grid';

  const makeCol = (title)=>{
    const col = document.createElement('div');
    const t = document.createElement('div'); t.className='muted'; t.style.fontSize='12px'; t.textContent=title; col.appendChild(t);
    const body = document.createElement('div'); body.className='case-col-body'; col.appendChild(body); return {col, body};
  };

  // input
  const {col:colIn, body:bodyIn} = makeCol('input');
  if(!drawMat(bodyIn, caze?.input)){
    const pre=document.createElement('pre'); pre.className='case-pre'; pre.textContent=dumpJsonCustom(caze?.input); bodyIn.appendChild(pre);
  }

  // expected
  const {col:colEx, body:bodyEx} = makeCol('expected');
  if(!drawMat(bodyEx, caze?.output)){
    const pre=document.createElement('pre'); pre.className='case-pre'; pre.textContent=dumpJsonCustom(caze?.output); bodyEx.appendChild(pre);
  }

  // actual
  const {col:colAc, body:bodyAc} = makeCol('actual');
  if(!drawMat(bodyAc, output)){
    const pre=document.createElement('pre'); pre.className='case-pre'; pre.textContent=dumpJsonCustom(output); bodyAc.appendChild(pre);
  }

  // dumps (only if present)
  if(hasDumps(dumps)){
    const colDump = document.createElement('div');
    colDump.className = 'col-dumps';
    renderDumpsColumn(colDump, dumps);
    grid.appendChild(colIn); grid.appendChild(colEx); grid.appendChild(colAc); grid.appendChild(colDump);
  } else {
    grid.appendChild(colIn); grid.appendChild(colEx); grid.appendChild(colAc);
  }
  card.appendChild(grid);
  return card;
}

function buildPager(container, page, totalPages){
  container.innerHTML='';
  if(totalPages<=1){ return; }
  const wrap = document.createElement('div');
  wrap.style.display='flex'; wrap.style.gap='8px'; wrap.style.alignItems='center';
  const btnPrev = document.createElement('button'); btnPrev.className='secondary btn-slim'; btnPrev.textContent='Prev'; btnPrev.disabled = page<=1;
  const btnNext = document.createElement('button'); btnNext.className='secondary btn-slim'; btnNext.textContent='Next'; btnNext.disabled = page>=totalPages;
  const label = document.createElement('span'); label.className='muted'; label.textContent = `page ${page} / ${totalPages}`;
  btnPrev.onclick = ()=> gotoPage(page-1);
  btnNext.onclick = ()=> gotoPage(page+1);
  wrap.appendChild(btnPrev); wrap.appendChild(btnNext); wrap.appendChild(label);
  container.appendChild(wrap);
}

function gotoPage(p){
  const params = new URLSearchParams(location.search);
  if(p<=1) params.delete('page'); else params.set('page', String(p));
  location.search = params.toString();
}

async function render(){
  const params = new URLSearchParams(location.search);
  const showAll = params.get('all')==='1' || document.getElementById('chkAll').checked;
  const currentPage = Math.max(1, parseInt(params.get('page')||'1', 10) || 1);
  const data = await fetch('/api/judge/outputs').then(r=>r.json());
  const taskId = data.task || null;
  const outputs = Array.isArray(data.outputs) ? data.outputs : [];
  const total = outputs.length;
  const ngCount = outputs.filter(x=> !x.verdict).length;
  const st = document.getElementById('status'); st.textContent = `cases: ${total}, NG: ${ngCount}`;
  const links = document.getElementById('taskLinks');
  if(taskId){
    const arcUrl = `https://github.com/google/ARC-GEN/blob/main/tasks/training/task${String(taskId).padStart(3, '0')}.py`;
    links.innerHTML = `<a href="/tasks/${taskId}">task${String(taskId).padStart(3,'0')}</a> &nbsp;|&nbsp; <a href="/tasks/${taskId}/cases">cases</a> &nbsp;|&nbsp; <a href="${arcUrl}" target="_blank" rel="noopener">ARC-GEN</a>`;
  }else{
    links.innerHTML='';
  }
  const root = document.getElementById('list'); root.innerHTML='';
  let items = outputs;
  if(!showAll){ items = items.filter(x=> !x.verdict); }
  const totalPages = Math.max(1, Math.ceil(items.length / 10));
  const page = Math.min(currentPage, totalPages);
  const start = (page-1)*10, end = start + 10;
  // まずカードを作ってDOMに追加
  const cards = items.slice(start, end).map(it=> renderCaseRow(it));
  cards.forEach(card=> root.appendChild(card));
  // 各カードの3カラム中で最大列数を拾ってセルサイズを計算して適用
  requestAnimationFrame(()=>{
    cards.forEach(card=>{
      const cols = [...card.querySelectorAll('.case-col-body .mat')];
      if(!cols.length) return;
      // カラムボディの幅（いちばん狭いもの）を採用
      const bodies = [...card.querySelectorAll('.case-col-body')];
      const colW = Math.max(1, Math.min(...bodies.map(b=> b.clientWidth||0)));
      // 入力・出力・実出力の最大列数
  const maxCols = Math.max(1, ...cols.map(m=> parseInt(m.dataset.cols||'0', 10) || 0));
      // 自動: floor(colW / maxCols), 上限12、さらにユーザの好み上限
      const pref = getPrefCell();
      const autoPx = Math.floor(colW / Math.max(1, maxCols));
      const px = Math.max(1, Math.min(12, autoPx, pref));
      cols.forEach(m=> m.style.setProperty('--cell', px+'px'));
    });
  });
  buildPager(document.getElementById('pagerTop'), page, totalPages);
  buildPager(document.getElementById('pagerBottom'), page, totalPages);
  LAST_MTIME = data.mtime || 0;
}

async function poll(){
  try{
    const d = await fetch(`/api/judge/outputs?since=${encodeURIComponent(LAST_MTIME||0)}`).then(r=>r.json());
    if(d && (d.mtime||0) !== LAST_MTIME){
      await render();
    }
  }catch{}
  setTimeout(poll, 1000);
}

(function init(){
  const params = new URLSearchParams(location.search);
  const chk = document.getElementById('chkAll');
  chk.checked = params.get('all')==='1';
  chk.addEventListener('change', ()=>{
    const p = new URLSearchParams(location.search);
    if(chk.checked) p.set('all','1'); else p.delete('all');
    p.delete('page');
    location.search = p.toString();
  });
  document.getElementById('btnReload').onclick = ()=> render();
  // size buttons
  applyActive(document.getElementById('sizeBtns'), (localStorage.getItem(SIZE_KEY)||'L'), 'size');
  document.getElementById('sizeBtns').onclick=(e)=>{
    const v=e.target.closest('button')?.dataset.size; if(!v) return; setCellKey(v); render();
  };
  const input = document.getElementById('cellPxInput');
  const saved = localStorage.getItem('cellPxManual');
  if(saved!=null){ const n=parseInt(saved,10); if(Number.isFinite(n) && n>0) input.value=String(n); }
  input.addEventListener('change', ()=>{
    const n = parseInt(input.value,10);
    if(Number.isFinite(n) && n>0){ localStorage.setItem('cellPxManual', String(n)); }
    else{ localStorage.removeItem('cellPxManual'); }
    render();
  });
  let t; window.addEventListener('resize', ()=>{ clearTimeout(t); t=setTimeout(()=> render(), 150); });
  document.addEventListener('keydown', (e)=>{
    if((e.key==='r' || e.key==='R') && !e.ctrlKey && !e.metaKey && !e.altKey){
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : '';
      if(tag==='input' || tag==='textarea' || (e.target && e.target.isContentEditable)) return;
      render();
    }
  });
  render(); poll();
})();
</script>
{% endblock %}
